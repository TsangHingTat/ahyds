//
//  homeView.swift
//  M3 UItra
//
//  Created by HingTatTsang on 15/8/2022.
//

import SwiftUI
import Combine

struct homeView: View {
    let defaults = UserDefaults.standard
    let timer = Timer.publish(every: 5, on: .main, in: .common).autoconnect()
    @Binding var welcome: Bool
    @State var showwelcome = false
    @State var username = ""
    @State var navtitle = NSLocalizedString("ÊàêÂ∞±", comment: "ÊàêÂ∞±")
    @State var health = Float(0)
    @State var caltoday = Float(0)
    @State var reward = 0
    @State var message = 0
    @State var cal1 = ""
    @State var cal2 = ""
    @State var cal3 = ""
    @State var cal4 = ""
    @State var showdate = false
    @State var water = Double(0)
    
    @State var open = false
    @State var popupViewShow = false
    
    @State var supportedsport = ["‰ª∞Ëá•Ëµ∑Âùê", "Êéå‰∏äÂ£ì"]
    @State var supportedsportdone = [true, false]
    
    @State var supportedsportname = ["sit-up", "pushup"]
    
    @State var viewnew = ["Sliver", "Gold", "Copper", "Aluminium", "Aluminium"]
    
    @StateObject private var healthKitManager = HealthKitManager()
    @State private var runningSpeed: Double?
    @State private var errorMessage: String?
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack {
                    VStack {
                        if let speed = runningSpeed {
                            Text("ÊúÄÂæå‰∏ÄÊ¨°Ë∑ëÊ≠•ÈÄüÂ∫¶Ôºö\(speed) Á±≥/Áßí")
                        } else if let error = errorMessage {
                            Text("ÈåØË™§Ôºö\(error)")
                        } else {
                            Text("Ë´ãÊ±ÇË∑ëÊ≠•ÈÄüÂ∫¶‰∏≠...")
                        }
                    }
                    .onChange(of: welcome) { _ in
                        healthKitManager.fetchRunningSpeed { (speed, error) in
                            if let speed = speed {
                                runningSpeed = speed
                            } else if let error = error {
                                errorMessage = error.localizedDescription
                            }
                        }
                    }
                    .onAppear {
//                        healthKitManager.authorizeHealthKit { (authorized, error) in
//                            if authorized {
                                healthKitManager.fetchRunningSpeed { (speed, error) in
                                    if let speed = speed {
                                        runningSpeed = speed
                                    } else if let error = error {
                                        errorMessage = error.localizedDescription
                                    }
                                }
//                            } else {
//                                errorMessage = error?.localizedDescription ?? "Êú™Áç≤Âæó HealthKit ÊéàÊ¨ä"
//                            }
//                        }
                    }
                    VStack {
                        if reward != 0 {
                            ScrollView(.horizontal, showsIndicators: false) {
                                HStack(alignment: .top, spacing: 0) {
                                    ForEach((0...reward), id: \.self) { i in
                                        ViewView(name: viewnew[i], title: viewnew[i])
                                    }
                                }
                                
                            }
                            .padding(.horizontal)
                        } else {
                            Text("ÁçéÂãµÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°...")
                                .font(.system(size: 30))
                                .frame(height: 120)
                                .padding(.horizontal)
                        }
                        
                    }
                    HStack {
                        VStack {
                            HStack {
                                VStack {
                                    ForEach((0...1), id: \.self) { i in
                                        HStack {
                                            Button(action: {
                                                open.toggle()
                                            }, label: {
                                                Rectangle()
                                                    .foregroundColor(.black)
                                                    .frame(height: 50)
                                                    .opacity(0.2)
                                                    .cornerRadius(15)
                                                    .overlay() {
                                                        HStack {
                                                            //      pushup
                                                            //      sit-up
                                                            if done_and_non_done().done_and_non_done(type_of_sport: "\(supportedsportname[i])") {
                                                                Text("‚úÖ")
                                                                    .font(.title)
                                                                    .padding()
                                                                    .foregroundColor(.white)
                                                            } else {
                                                                Text("üî¥")
                                                                    .font(.title)
                                                                    .padding()
                                                                    .foregroundColor(.white)
                                                            }
                                                            Text(NSLocalizedString("\(supportedsport[i])", comment: "\(supportedsport[i])"))
                                                                .font(.title)
                                                                .foregroundColor(.white)
                                                            Spacer()
                                                        }
                                                    }
                                            })
                                        }
                                        .fullScreenCover(isPresented: $open) {
                                            aiView(onoff: $open, need: 30, title: "\(NSLocalizedString("\(supportedsport[i])", comment: "\(supportedsport[i])"))")
                                        }
                                    }
                                }
                                Spacer()
                                Button(action: {
                                    popupViewShow.toggle()
                                }, label: {
                                    Group {
                                        ZStack {
                                            Rectangle()
                                                .cornerRadius(25)
                                                .foregroundColor(.white)
                                                .frame(width: 140, height: 140)
                                                .padding()
                                            Rectangle()
                                                .cornerRadius(25)
                                                .foregroundColor(.white)
                                                .opacity(0.7)
                                                .frame(width: 140, height: 140)
                                                .padding()
                                                .overlay() {
                                                    ZStack {
                                                        waterView(percent: $water)
                                                            .mask(Rectangle().cornerRadius(25).foregroundColor(.white).opacity(0.7).frame(height: 140).padding())
                                                        if caltoday >= 2000 {
                                                            Rectangle().cornerRadius(25).foregroundColor(.green).frame(height: 140).padding()
                                                        }
                                                        // MARK: ‰ªªÂãô Pie Chart
                                                        HStack {
                                                            // MARK: Âç°Ë∑ØÈáå
                                                            VStack {
                                                                Image("cal")
                                                                    .resizable()
                                                                    .scaledToFit()
                                                                    .overlay() {
                                                                        ZStack {
                                                                            VStack {
                                                                                Text("‰ªäÂ§©")
                                                                                    .foregroundColor(.black)
                                                                                    .font(.title3)
                                                                                Text("\(Int(loadcaldata()))/2,000")
                                                                                    .foregroundColor(.black)
                                                                                    .font(.title3)
                                                                                Text("Âç°Ë∑ØÈáå")
                                                                                    .foregroundColor(.black)
                                                                                    .font(.title3)
                                                                            }
                                                                            
                                                                        }
                                                                    }
                                                            }
                                                            
                                                        }
                                                    }
                                                }
                                                .onAppear() {
                                                    water = Double((Int(caltoday)/2000)*100)
                                                    let newwater = Double(water)
                                                    printnow(message: "\(newwater)")
                                                }
                                        }
                                        .environment(\.colorScheme, .light)
                                        .shadow(radius: 5)
                                    }
                                })
                            }
                            todayView(year: "", month: "", istoday: true, home: true)
                                .shadow(radius: 5)
                        }
                    }
                    .frame(maxWidth: 500)
                }
                
            }
            .sheet(isPresented: $popupViewShow) {
                NavigationView {
                    GeometryReader { proxy in
                        TabView {
                            LazyVStack {
                                VStack {
                                    VStack {
                                        ZStack {
                                            HStack {
                                                // MARK: Âç°Ë∑ØÈáå
                                                VStack {
                                                    let callllll = Float(loadcaldata())
                                                    let temp: CGFloat = CGFloat(callllll/2000)
                                                    RingView(percentage: temp, backgroundColor: .white, startColor: .red, endColor: .green, thickness: 35)
                                                }
                                                .overlay() {
                                                    ZStack {
                                                        VStack {
                                                            Text("‰ªäÂ§©")
                                                                .foregroundColor(.black)
                                                                .font(.title)
                                                            Text("\(Int(loadcaldata()))/2,000")
                                                                .foregroundColor(.black)
                                                                .font(.title)
                                                            Text("Âç°Ë∑ØÈáå")
                                                                .foregroundColor(.black)
                                                                .font(.title)
                                                        }
                                                        
                                                    }
                                                    .padding()
                                                }
                                                
                                            }
                                        }
                                        calchartView()
                                    }
                                }
                                .frame(width: proxy.size.width, height: proxy.size.height)
                                .rotationEffect(.degrees(-90))
                            }
                            
                            
                        }
                        .frame(width: proxy.size.height, height: proxy.size.width)
                        .rotationEffect(.degrees(90), anchor: .topLeading)
                        .offset(x: proxy.size.width)
                        .tabViewStyle(PageTabViewStyle(indexDisplayMode: .never))
                    }
                    .navigationBarTitle("Ë®òÈåÑ")
                }
            }
            .background() {
                Image("background1")
                    .resizable()
                    .padding()
                    .fixedSize(horizontal: true, vertical: true)
                    .opacity(0.5)
            }
            
            // MARK: Ê®ôÈ°å
            .navigationTitle(navtitle)
            
        }
        
        
        .environment(\.colorScheme, .dark)
        
        // MARK: ËºâÂÖ•Êï∏Êìö
        .onAppear() {
            runwelcome()
            health = loadcaldata()/2000
            caltoday = loadcaldata()
            reward = getdata().getdefaultsdataint(type: "reward")
            showdateload()
            
        }
        // MARK: Ëá™ÂãïÊõ¥ËÆäÊ®ôÈ°åÊñáÂ≠ó
        .onReceive(timer) { input in
            if showwelcome {
                if message != 3 {
                    message = message+1
                } else {
                    message = 1
                }
                if message == 1 {
                    runwelcome()
                    printnow(message: "Ê≠°Ëøé, \(username)")
                } else if message == 2{
                    navtitle = "\(NSLocalizedString("Â∑≤ÂÆåÊàê", comment: "Â∑≤ÂÆåÊàê"))\(Int(health*100))\(NSLocalizedString("%‰ªªÂãô", comment: "%‰ªªÂãô"))"
                    printnow(message: "Â∑≤ÂÆåÊàê\(Int(health*100))%‰ªªÂãô")
                } else if message == 3 {
                    navtitle = "\(NSLocalizedString("Â∑≤Ê∂àËÄó", comment: "Â∑≤Ê∂àËÄó")) \(Int(caltoday)) \(NSLocalizedString("Âç°Ë∑ØÈáå", comment: "Âç°Ë∑ØÈáå"))"
                    printnow(message: "Â∑≤Ê∂àËÄó \(Int(caltoday)) Âç°Ë∑ØÈáå")
                }
            }
        }
        .navigationViewStyle(StackNavigationViewStyle())
        //        .frame(maxWidth: 700)
    }
    // MARK: Âà∑Êñ∞Êï∏Êìö
    func loadcaldata() -> Float {
        printnow(message: "loadcaldata()")
        let today = Date()
        let formatter1 = DateFormatter()
        formatter1.dateFormat = "yyyy-MM-dd"
        let datedatanow = "\(formatter1.string(from: today))"
        let sum1 = stringtofloat(string: getdata().getdata(date: datedatanow, datanum: 5))
        let sum2 = stringtofloat(string: getdata().getdata(date: datedatanow, datanum: 6))
        let sum3 = stringtofloat(string: getdata().getdata(date: datedatanow, datanum: 7))
        let sum4 = stringtofloat(string: getdata().getdata(date: datedatanow, datanum: 8))
        let datacal = String(sum1+sum2+sum3+sum4)
        let loaddata = datacal
        return Float(loaddata) ?? 0
    }
    func showdateload() -> Void {
        printnow(message: "loadcaldata()")
        let today = Date()
        let formatter1 = DateFormatter()
        formatter1.dateFormat = "dd/MM/yyyy"
        let datedatanow = "\(formatter1.string(from: today))"
        let datamem = defaults.string(forKey: "\(datedatanow)dataitem1")
        if datamem == nil {
            showdate = false
        } else {
            showdate = true
        }
        
    }
    
    // MARK: Ê™¢Êü•ÊòØÂê¶ÊúâÂú®Ë®≠ÂÆö‰∏≠ÊâìÈñã"Ê≠°ËøéË®äÊÅØ"
    func runwelcome() -> Void {
        printnow(message: "runwelcome()")
        username = defaults.string(forKey: "username") ?? "USERNAME"
        showwelcome = defaults.bool(forKey: "showwelcome")
        if showwelcome {
            navtitle = "\(NSLocalizedString("Ê≠°Ëøé", comment: "Ê≠°Ëøé")), \(username)"
        }
    }
    func stringtofloat(string: String) -> Float {
        let numberFormatter = NumberFormatter()
        let number = numberFormatter.number(from: string)
        let numberFloatValue = number?.floatValue ?? 0
        return numberFloatValue
    }
    
    func printnow(message: String) {
        let today = Date()
        let hours   = (Calendar.current.component(.hour, from: today))
        let minutes = (Calendar.current.component(.minute, from: today))
        let seconds = (Calendar.current.component(.second, from: today))
        let formatter1 = DateFormatter()
        formatter1.dateFormat = "dd/MM/yyyy"
        let datedatanow = "\(formatter1.string(from: today))"
        NSLog("homeView: \(datedatanow) \(hours):\(minutes):\(seconds) - \(message)")
        
    }
    func getdatecalc(day: Int) -> String {
        guard let tday = Calendar.current.date(byAdding: .day, value: day, to: Date.now) else { return "E" }
        let formatter1 = DateFormatter()
        formatter1.dateFormat = "yyyy-MM-dd"
        let datedatanow = "\(formatter1.string(from: tday))"
        return datedatanow
    }
    
    
}



struct homeView_Previews: PreviewProvider {
    static var previews: some View {
        homeView(welcome: .constant(false))
    }
}
